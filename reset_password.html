<!DOCTYPE html>
<html>
<head>
  <title>비밀번호 재설정</title>
  <style>
    body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f0f2f5; }
    .container { background-color: #ffffff; padding: 40px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); text-align: center; max-width: 400px; width: 100%; }
    input { width: 100%; padding: 10px; margin: 10px 0; box-sizing: border-box; border-radius: 5px; border: 1px solid #ccc; }
    button { width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container">
    <h1>새 비밀번호 설정</h1>
    <p>새로운 비밀번호를 입력해주세요.</p>
    <form id="reset-form">
      <input type="password" id="new-password" placeholder="새 비밀번호" required>
      <input type="password" id="confirm-password" placeholder="새 비밀번호 확인" required>
      <button type="submit">비밀번호 변경</button>
    </form>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script>
    document.getElementById('reset-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;

      if (newPassword !== confirmPassword) {
        alert('비밀번호가 일치하지 않습니다.');
        return;
      }
      
      try {
        const url = new URL(window.location.href);
        const params = new URLSearchParams(url.search);
        console.log("params : ", params);
        const code = params.get('code');
        console.log("code : ", code);

        if (!code) {
            alert('유효하지 않은 링크입니다.');
            return;
        }

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ✅ code를 사용하여 세션 교환
        const { error: sessionError } = await supabase.auth.exchangeCodeForSession(code);
        
        if (sessionError) {
          alert('세션 설정 실패: ' + sessionError.message);
          return;
        }

        // ✅ 세션이 설정된 후 비밀번호 업데이트
        const { error: updateError } = await supabase.auth.updateUser({
            password: newPassword,
        });

        if (updateError) {
          alert('비밀번호 변경 실패: ' + updateError.message);
        } else {
          alert('비밀번호가 성공적으로 변경되었습니다!');
          window.close();
        }
      } catch (err) {
        alert('오류가 발생했습니다: ' + err.message);
      }
    });
  </script>
</body>
</html>
